{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Quản lý người dùng - REHEARTEN{% endblock %}

{% block content %}
<style>
    .users-header {
        background: white;
        border-radius: 24px;
        padding: 32px 40px;
        margin-bottom: 32px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #f1f5f9;
        position: relative;
        overflow: hidden;
        animation: slideInDown 0.8s ease-out;
    }
    
    .users-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #0284c7, #38bdf8);
    }
    
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .users-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .users-subtitle {
        color: #6b7280;
        font-size: 1rem;
        margin-bottom: 24px;
    }
    
    .action-bar {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
    }
    
    .search-box {
        flex: 1;
        max-width: 400px;
        position: relative;
    }
    
    .search-box input {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 12px 16px 12px 56px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .search-box input:focus {
        border-color: #0284c7;
        box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        background: white;
    }
    
    .search-logo {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
    }
    
    .search-logo img {
        transition: all 0.3s ease;
    }
    
    .search-box:hover .search-logo img {
        transform: scale(1.1);
    }
    
    .action-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .btn-action {
        background: linear-gradient(135deg, #0284c7, #38bdf8);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.3);
        color: white;
    }
    
    .btn-action.secondary {
        background: #f8fafc;
        color: #374151;
        border: 1px solid #e2e8f0;
    }
    
    .btn-action.secondary:hover {
        background: #0284c7;
        color: white;
        border-color: #0284c7;
    }
    
    .btn-action.info {
        background: linear-gradient(135deg, #38bdf8, #0ea5e9);
    }
    
    .btn-action.info:hover {
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.3);
    }
    
    .users-table-container {
        background: white;
        border-radius: 24px;
        padding: 32px;
        margin-bottom: 32px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #f1f5f9;
        animation: slideInUp 0.8s ease-out 0.2s both;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .table-wrapper {
        background: #f8fafc;
        border-radius: 16px;
        padding: 16px;
        margin-top: 20px;
        border: 1px solid #e2e8f0;
    }
    
    .users-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin: 0;
    }
    
    .users-table thead th {
        background: #f8fafc;
        color: #374151;
        font-weight: 600;
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.9rem;
        border: none;
    }
    
    .users-table tbody td {
        padding: 16px 20px;
        border-bottom: 1px solid #f1f5f9;
        color: #6b7280;
        vertical-align: middle;
        border: none;
    }
    
    .users-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .users-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0284c7, #38bdf8);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 12px;
        font-size: 0.9rem;
    }
    
    .user-info {
        display: flex;
        align-items: center;
    }
    
    .user-name {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
    }
    
    .user-email {
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .role-badge {
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: capitalize;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .role-badge::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }
    
    .role-badge:hover::before {
        left: 100%;
    }
    
    .role-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .role-badge.admin {
        background: #fef2f2;
        color: #0369a1;
        border: 1px solid #fecaca;
    }
    
    .role-badge.user {
        background: #f0f9ff;
        color: #0ea5e9;
        border: 1px solid #bae6fd;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .status-badge.active {
        background: #f0f9ff;
        color: #0ea5e9;
        border: 1px solid #bae6fd;
    }
    
    .status-badge.inactive {
        background: #fef2f2;
        color: #0369a1;
        border: 1px solid #fecaca;
    }
    
    .action-buttons-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .action-btn-small {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        color: #6b7280;
        padding: 6px 10px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .action-btn-small:hover {
        background: #0284c7;
        border-color: #0284c7;
        color: white;
        transform: translateY(-1px);
    }
    
    .action-btn-small.danger:hover {
        background: #0369a1;
        border-color: #0369a1;
    }
    
    .action-btn-small.warning:hover {
        background: #f59e0b;
        border-color: #f59e0b;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
        animation: slideInUp 0.8s ease-out 0.4s both;
    }
    
    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #f1f5f9;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 1.2rem;
        color: white;
    }
    
    .stat-icon.primary { background: linear-gradient(135deg, #0284c7, #38bdf8); }
    .stat-icon.info { background: linear-gradient(135deg, #38bdf8, #0ea5e9); }
    .stat-icon.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-icon.info { background: linear-gradient(135deg, #0369a1, #0c4a6e); }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 6px;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    /* Role Change Modal Styles */
    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        border-bottom: 1px solid #f1f5f9;
        padding: 24px 32px 20px;
    }
    
    .modal-body {
        padding: 20px 32px 32px;
    }
    
    .role-option {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .role-option:hover {
        border-color: #0284c7;
        background: #f0f9ff;
    }
    
    .role-option.selected {
        border-color: #0284c7;
        background: #f0f9ff;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
    }
    
    .role-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
    }
    
    .role-icon.admin { background: linear-gradient(135deg, #0369a1, #0c4a6e); }
    .role-icon.user { background: linear-gradient(135deg, #0284c7, #38bdf8); }
    
    .role-details h6 {
        margin: 0 0 4px 0;
        color: #1f2937;
        font-weight: 600;
    }
    
    .role-details small {
        color: #6b7280;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .users-header {
            padding: 24px 20px;
        }
        
        .users-title {
            font-size: 1.8rem;
        }
        
        .action-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            max-width: none;
            margin-bottom: 16px;
        }
        
        .action-buttons {
            justify-content: center;
        }
        
        .users-table-container {
            padding: 20px;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
    }
    
    /* Alert animations */
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .dynamic-alert {
        animation: slideInRight 0.3s ease-out;
    }
    
    /* Loading states */
    .btn-loading {
        position: relative;
        color: transparent !important;
    }
    
    .btn-loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Enhanced role badge hover effects */
    .role-badge {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .role-badge::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }
    
    .role-badge:hover::before {
        left: 100%;
    }
    
    .role-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Success animation for updated roles */
    .role-updated {
        animation: roleUpdatePulse 0.6s ease-out;
    }
    
    @keyframes roleUpdatePulse {
        0% { transform: scale(1); }
        50% { 
            transform: scale(1.1); 
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.6);
        }
        100% { transform: scale(1); }
    }
</style>

<div class="container-fluid">
    <!-- Users Management Header -->
    <div class="users-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="users-title">
                    <i class="fas fa-users-cog"></i>
                    Quản lý người dùng
                </h1>
                <p class="users-subtitle">
                    Quản lý tài khoản và phân quyền cho {{ users|length }} người dùng trong hệ thống
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex flex-column align-items-end">
                    <small class="text-muted">Tổng số người dùng</small>
                    <span class="badge" style="background: linear-gradient(135deg, #0284c7, #38bdf8); color: white; font-size: 1rem; padding: 8px 16px;">
                        {{ users|length }} users
                    </span>
                </div>
            </div>
        </div>
        
        <div class="action-bar">
            <div class="search-box">
                <div class="search-logo">
                    <img src="{% static 'images/logo_optionbar.png' %}" alt="REHEARTEN" style="width: 24px; height: 24px; border-radius: 6px;">
                </div>
                <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên, email, vai trò...">
            </div>
            <div class="action-buttons">
                <a href="{% url 'register' %}" class="btn-action info">
                    <i class="fas fa-user-plus"></i>
                    Thêm người dùng
                </a>
                <button class="btn-action secondary" onclick="loadUserStats()">
                    <i class="fas fa-chart-bar"></i>
                    Thống kê
                </button>
                <button class="btn-action secondary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                    Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-number">{{ users|length }}</div>
            <div class="stat-label">Tổng người dùng</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-number">
                {{ users|length }}
               
            </div>
            <div class="stat-label">Đang hoạt động</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-crown"></i>
            </div>
            <div class="stat-number" id="adminCount">
                0
            </div>
            <div class="stat-label">Quản trị viên</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="stat-number" id="userCount">
                0
            </div>
            <div class="stat-label">Người dùng thường</div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-container">
        <h3 style="color: #1f2937; font-weight: 600; margin-bottom: 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-table"></i>
            Danh sách người dùng
        </h3>
        
        <div class="table-wrapper">
            <table class="users-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Người dùng</th>
                        <th>Vai trò</th>
                        <th>Ngày tham gia</th>
                        <th>Lần cuối online</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    {{ u.first_name|first|upper }}
                                </div>
                                <div>
                                    <div class="user-name">
                                        {{ u.username }}
                                        {% if u.username == user.username %}
                                            <span class="badge" style="background: #f0f9ff; color: #0ea5e9; font-size: 0.7rem;">Bạn</span>
                                        {% endif %}
                                    </div>
                                    <div class="user-email">{{ u.email }}</div>
                                    <small style="color: #9ca3af;">{{ u.get_full_name }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="role-badge {{ u.role }}" onclick="changeUserRole('{{ u.username }}', '{{ u.role }}')" 
                                 {% if u.username != user.username %}title="Click để thay đổi vai trò"{% endif %}>
                                {% if u.role == 'admin' %}
                                    <i class="fas fa-crown"></i>
                                    {{ u.get_role_display }}
                                {% else %}
                                    <i class="fas fa-user"></i>
                                    {{ u.get_role_display }}
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if u.date_joined %}
                                {{ u.date_joined|date:"d/m/Y" }}<br>
                                <small style="color: #9ca3af;">{{ u.date_joined|date:"H:i" }}</small>
                            {% else %}
                                <span style="color: #9ca3af;">Không rõ</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if u.last_login %}
                                {{ u.last_login|date:"d/m/Y" }}<br>
                                <small style="color: #9ca3af;">{{ u.last_login|date:"H:i" }}</small>
                            {% else %}
                                <span style="color: #9ca3af;">Chưa đăng nhập</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="status-badge {% if u.is_active %}active{% else %}inactive{% endif %}">
                                {% if u.is_active %}
                                    <i class="fas fa-check-circle"></i>
                                    Hoạt động
                                {% else %}
                                    <i class="fas fa-times-circle"></i>
                                    Không hoạt động
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons-group">
                                <button class="action-btn-small" onclick="viewUserDetails('{{ u.username }}')" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if u.username != user.username %}
                                    <a href="{% url 'edit_user' u.username %}" class="action-btn-small" title="Chỉnh sửa">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="action-btn-small danger toggle-status-btn" 
                                            data-username="{{ u.username }}"
                                            data-active="{{ u.is_active|yesno:'true,false' }}"
                                            title="{% if u.is_active %}Vô hiệu hóa{% else %}Kích hoạt{% endif %}">
                                        <i class="fas fa-{% if u.is_active %}ban{% else %}check{% endif %}"></i>
                                    </button>
                                {% else %}
                                <span class="badge" style="background: #dbeafe; color: #1d4ed8; font-size: 0.7rem;">Tài khoản của bạn</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 40px; color: #9ca3af;">
                            <i class="fas fa-users fa-3x mb-3" style="color: #e5e7eb;"></i><br>
                            Không có người dùng nào trong hệ thống
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Role Change Modal -->
<div class="modal fade" id="roleChangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-tag me-2"></i>Thay đổi vai trò người dùng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600; color: #374151;">Người dùng:</label>
                    <div style="background: #f8fafc; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <strong id="targetUsername"></strong>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600; color: #374151;">Chọn vai trò mới:</label>
                    <div id="roleOptions">
                        <div class="role-option" data-role="admin">
                            <div class="role-icon admin">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="role-details">
                                <h6>Quản trị viên</h6>
                                <small>Quyền truy cập đầy đủ vào hệ thống</small>
                            </div>
                        </div>
                        
                        <div class="role-option" data-role="user">
                            <div class="role-icon user">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="role-details">
                                <h6>Người dùng</h6>
                                <small>Quyền truy cập cơ bản vào các tính năng</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="border: none; padding: 0; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 12px;">
                        Hủy bỏ
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmRoleChange()" style="background: linear-gradient(135deg, #0284c7, #38bdf8); border: none; border-radius: 12px;">
                        <i class="fas fa-save me-2"></i>Lưu thay đổi
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-circle me-2"></i>Chi tiết người dùng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
let currentUsername = '';
let selectedRole = '';

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    }
});

// Role change functionality
function changeUserRole(username, currentRole) {
    if (username === '{{ user.username }}') {
        showAlert('Bạn không thể thay đổi vai trò của chính mình!', 'warning');
        return;
    }
    
    currentUsername = username;
    document.getElementById('targetUsername').textContent = username;
    
    // Reset role options
    const options = document.querySelectorAll('.role-option');
    options.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.role === currentRole) {
            option.classList.add('selected');
            selectedRole = currentRole;
        }
    });
    
    const modal = new bootstrap.Modal(document.getElementById('roleChangeModal'));
    modal.show();
}

// Role option selection
document.querySelectorAll('.role-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        selectedRole = this.dataset.role;
    });
});

// Confirm role change
function confirmRoleChange() {
    if (!selectedRole) {
        showAlert('Vui lòng chọn vai trò!', 'warning');
        return;
    }
    
    // Show loading state
    const confirmBtn = document.querySelector('#roleChangeModal .btn-primary');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
    confirmBtn.disabled = true;
    
    fetch('/api/change-user-role/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            username: currentUsername,
            role: selectedRole
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Update the role badge in the table
            updateUserRoleInTable(currentUsername, data.user.new_role, data.user.new_role_display);
            // Update statistics
            updateRoleStatistics();
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('roleChangeModal')).hide();
        } else {
            showAlert('Lỗi: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Có lỗi xảy ra: ' + error, 'error');
    })
    .finally(() => {
        // Reset button state
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// Update role badge in table without reloading
function updateUserRoleInTable(username, newRole, newRoleDisplay) {
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const usernameCell = row.cells[0].textContent;
        
        if (usernameCell.includes(username)) {
            const roleBadge = row.cells[1].querySelector('.role-badge');
            if (roleBadge) {
                // Add success animation class
                roleBadge.classList.add('role-updated');
                
                // Update badge class and content
                roleBadge.className = `role-badge ${newRole} role-updated`;
                roleBadge.onclick = function() { changeUserRole(username, newRole); };
                
                // Update icon and text
                const icon = newRole === 'admin' ? 'fas fa-crown' : 'fas fa-user';
                roleBadge.innerHTML = `<i class="${icon}"></i> ${newRoleDisplay}`;
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    roleBadge.classList.remove('role-updated');
                }, 600);
                
                // Highlight the entire row briefly
                row.style.backgroundColor = '#f0f9ff';
                row.style.transition = 'background-color 0.3s ease';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            }
            break;
        }
    }
}

// Update role statistics
function updateRoleStatistics() {
    // This is a simple implementation - you could make an API call to get updated stats
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tr');
    let adminCount = 0;
    let userCount = 0;
    
    for (let i = 1; i < rows.length; i++) {
        const roleBadge = rows[i].cells[1].querySelector('.role-badge');
        if (roleBadge && roleBadge.classList.contains('admin')) {
            adminCount++;
        } else if (roleBadge && roleBadge.classList.contains('user')) {
            userCount++;
        }
    }
    
    // Update stat cards
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
        const label = card.querySelector('.stat-label').textContent;
        const number = card.querySelector('.stat-number');
        
        if (label.includes('Quản trị viên')) {
            number.textContent = adminCount;
        } else if (label.includes('Người dùng thường')) {
            number.textContent = userCount;
        }
    });
}

// Enhanced alert function
function showAlert(message, type = 'info') {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.dynamic-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show dynamic-alert`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
        animation: slideInRight 0.3s ease-out;
    `;
    
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'error' ? 'exclamation-circle' : 
                 type === 'warning' ? 'exclamation-triangle' : 'info-circle';
    
    alertDiv.innerHTML = `
        <i class="fas fa-${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Toggle user status
function toggleUserStatus(username, isActive) {
    const action = isActive ? 'vô hiệu hóa' : 'kích hoạt';
    const actionColor = isActive ? '#0369a1' : '#0ea5e9';
    const icon = isActive ? 'ban' : 'check';
    
    // Create beautiful confirmation modal
    const confirmationHtml = `
        <div class="modal fade" id="statusConfirmModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                    <div class="modal-header" style="border-bottom: 1px solid #f1f5f9; padding: 24px 32px 20px;">
                        <h5 class="modal-title" style="color: ${actionColor};">
                            <i class="fas fa-${icon} me-2"></i>
                            Xác nhận ${action} người dùng
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="padding: 20px 32px 32px;">
                        <div class="text-center mb-4">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: ${actionColor}; color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 16px;">
                                <i class="fas fa-${icon}"></i>
                            </div>
                            <h6>Bạn có chắc muốn ${action} người dùng <strong>${username}</strong>?</h6>
                            <p class="text-muted mb-0">
                                ${isActive ? 
                                    'Người dùng sẽ không thể đăng nhập và sử dụng hệ thống.' : 
                                    'Người dùng sẽ có thể đăng nhập và sử dụng hệ thống trở lại.'
                                }
                            </p>
                        </div>
                        <div class="d-flex gap-3 justify-content-center">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 12px; padding: 12px 24px;">
                                <i class="fas fa-times me-2"></i>Hủy
                            </button>
                            <button type="button" class="btn" id="confirmToggleBtn" 
                                    style="background: ${actionColor}; color: white; border: none; border-radius: 12px; padding: 12px 24px;"
                                    onclick="executeToggleStatus('${username}')">
                                <i class="fas fa-${icon} me-2"></i>Xác nhận ${action}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('statusConfirmModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', confirmationHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('statusConfirmModal'));
    modal.show();
}

// Execute the actual toggle operation
function executeToggleStatus(username) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('statusConfirmModal'));
    const confirmBtn = document.getElementById('confirmToggleBtn');
    
    // Show loading state
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
    confirmBtn.disabled = true;
    
    // Prepare data
    const data = {
        username: username
    };
    
    // Call API
    fetch('/api/toggle-user-status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        modal.hide();
        
        if (data.success) {
            // Show success message
            showAlert(data.message, 'success');
            
            // Update the user row in the table
            updateUserRowStatus(username, data.user);
            
            // Update statistics
            updateStatusStatistics();
            
            // Log the action
            console.log(`[SUCCESS] ${data.user.action} user ${username} by admin`);
        } else {
            // Show error message
            showAlert(data.error || 'Có lỗi xảy ra khi thay đổi trạng thái người dùng', 'error');
        }
    })
    .catch(error => {
        modal.hide();
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi kết nối đến server', 'error');
    })
    .finally(() => {
        // Clean up modal
        setTimeout(() => {
            const modalElement = document.getElementById('statusConfirmModal');
            if (modalElement) {
                modalElement.remove();
            }
        }, 500);
    });
}

// Update user row status in the table
function updateUserRowStatus(username, userData) {
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const userInfo = row.querySelector('.user-name');
        
        if (userInfo && userInfo.textContent.trim().includes(username)) {
            // Update status badge
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge ${userData.new_status ? 'active' : 'inactive'}`;
                statusBadge.innerHTML = userData.new_status ? 
                    '<i class="fas fa-check-circle"></i> Hoạt động' : 
                    '<i class="fas fa-times-circle"></i> Không hoạt động';
            }
            
            // Update toggle button
            const toggleBtn = row.querySelector('.toggle-status-btn');
            if (toggleBtn) {
                toggleBtn.dataset.active = userData.new_status.toString();
                toggleBtn.title = userData.new_status ? 'Vô hiệu hóa' : 'Kích hoạt';
                toggleBtn.querySelector('i').className = `fas fa-${userData.new_status ? 'ban' : 'check'}`;
            }
            
            // Add highlight effect
            row.style.backgroundColor = '#f0f9ff';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
            
            break;
        }
    }
}

// Update status statistics
function updateStatusStatistics() {
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tr');
    let activeCount = 0;
    let inactiveCount = 0;
    
    for (let i = 1; i < rows.length; i++) {
        const statusBadge = rows[i].querySelector('.status-badge');
        if (statusBadge && statusBadge.classList.contains('active')) {
            activeCount++;
        } else if (statusBadge && statusBadge.classList.contains('inactive')) {
            inactiveCount++;
        }
    }
    
    // Update stat cards if they exist
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
        const label = card.querySelector('.stat-label').textContent;
        const number = card.querySelector('.stat-number');
        
        if (label.includes('Hoạt động')) {
            number.textContent = activeCount;
        } else if (label.includes('Không hoạt động')) {
            number.textContent = inactiveCount;
        }
    });
}

// View user details
function viewUserDetails(username) {
    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    const content = document.getElementById('userDetailsContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status" style="color: #0284c7;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Load user details (you can implement an API endpoint for this)
    setTimeout(() => {
        content.innerHTML = `
            <div class="row">
                <div class="col-md-4 text-center">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #0284c7, #38bdf8); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 16px;">
                        ${username.charAt(0).toUpperCase()}
                    </div>
                    <h5>${username}</h5>
                </div>
                <div class="col-md-8">
                    <div class="mb-3">
                        <strong>Username:</strong> ${username}
                    </div>
                    <div class="mb-3">
                        <strong>Vai trò:</strong> <span class="badge bg-info">User</span>
                    </div>
                    <div class="mb-3">
                        <strong>Trạng thái:</strong> <span class="badge bg-info">Hoạt động</span>
                    </div>
                    <div class="mb-3">
                        <strong>Ngày tham gia:</strong> Đang tải...
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

// Refresh functionality
document.getElementById('refreshBtn').addEventListener('click', function() {
    location.reload();
});

// Toggle user status functionality
document.addEventListener('DOMContentLoaded', function() {
    // Count and update role statistics on page load
    updateRoleStatistics();
    
    document.querySelectorAll('.toggle-status-btn').forEach(button => {
        button.addEventListener('click', function() {
            const username = this.dataset.username;
            const isActive = this.dataset.active === 'true';
            toggleUserStatus(username, isActive);
        });
    });
});

// Load user stats
function loadUserStats() {
    alert('Tính năng thống kê chi tiết sẽ được triển khai trong phiên bản tiếp theo.');
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 