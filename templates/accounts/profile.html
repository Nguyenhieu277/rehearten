{% extends 'accounts/base.html' %}

{% block title %}Th√¥ng tin c√° nh√¢n - REHEARTEN{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h4><i class="fas fa-user-edit me-2"></i>Th√¥ng tin c√° nh√¢n</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <form id="profile-form" action="{% url 'api_profile' %}">
                            {% csrf_token %}
                            
                            <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
                            <div id="form-success" class="alert alert-info" style="display: none;"></div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-user me-1"></i>T√™n
                                    </label>
                                    {{ form.first_name }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-user me-1"></i>H·ªç
                                    </label>
                                    {{ form.last_name }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email
                                </label>
                                {{ form.email }}
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-times me-1"></i>H·ªßy
                                </a>
                                <button type="button" id="update-profile-btn" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6><i class="fas fa-info-circle me-1"></i>Th√¥ng tin t√†i kho·∫£n</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    <li><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> {{ user.username }}</li>
                                    <li><strong>Ng√†y tham gia:</strong> {{ user.date_joined|date:"d/m/Y H:i" }}</li>
                                    <li><strong>L·∫ßn cu·ªëi online:</strong> 
                                        {% if user.last_login %}
                                            {{ user.last_login|date:"d/m/Y H:i" }}
                                        {% else %}
                                            Ch∆∞a ƒëƒÉng nh·∫≠p
                                        {% endif %}
                                    </li>
                                    <li><strong>Tr·∫°ng th√°i:</strong> 
                                        {% if user.is_active %}
                                            <span class="badge bg-info">Ho·∫°t ƒë·ªông</span>
                                        {% else %}
                                            <span class="badge bg-danger">Kh√¥ng ho·∫°t ƒë·ªông</span>
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card bg-info bg-opacity-25 mt-3">
                            <div class="card-body text-center">
                                <i class="fas fa-key fa-2x text-info mb-2"></i>
                                <h6>ƒê·ªïi m·∫≠t kh·∫©u</h6>
                                <p class="small">ƒê·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n c·ªßa b·∫°n</p>
                                <a href="{% url 'change_password' %}" class="btn btn-info btn-sm">
                                    <i class="fas fa-lock me-1"></i>ƒê·ªïi m·∫≠t kh·∫©u
                                </a>
                            </div>
                        </div>
                        
                        <div class="card bg-info bg-opacity-25 mt-3">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-2x text-info mb-2"></i>
                                <h6>B·∫£o m·∫≠t t√†i kho·∫£n</h6>
                                <p class="small">Lu√¥n gi·ªØ t√†i kho·∫£n an to√†n</p>
                                <div class="d-flex flex-column gap-2">
                                    <a href="{% url 'change_password' %}" class="btn btn-outline-info btn-sm">
                                        <i class="fas fa-key me-1"></i>ƒê·ªïi m·∫≠t kh·∫©u
                                    </a>
                                    <small class="text-muted">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u ƒë·ªãnh k·ª≥</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Profile page JavaScript loaded");
    
    const updateButton = document.getElementById('update-profile-btn');
    const profileForm = document.getElementById('profile-form');
    const errorContainer = document.getElementById('form-errors');
    const successContainer = document.getElementById('form-success');

    if (updateButton && profileForm) {
        updateButton.addEventListener('click', function(event) {
            event.preventDefault();
            console.log("üîÑ Starting profile update...");
            
            // Disable button and show loading
            updateButton.disabled = true;
            updateButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang c·∫≠p nh·∫≠t...';
            
            // Hide previous messages
            errorContainer.style.display = 'none';
            successContainer.style.display = 'none';
            
            // Get form data
            const formData = new FormData(profileForm);
            const payload = {};
            
            // Collect only non-empty fields
            formData.forEach((value, key) => {
                if (key !== 'csrfmiddlewaretoken' && value.trim() !== '') {
                    payload[key] = value.trim();
                }
            });
            
            console.log("üì§ Sending PATCH request with data:", payload);
            
            if (Object.keys(payload).length === 0) {
                alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt th√¥ng tin ƒë·ªÉ c·∫≠p nh·∫≠t.');
                updateButton.disabled = false;
                updateButton.innerHTML = '<i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t';
                return;
            }

            // Send PATCH request
            fetch(profileForm.action, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log("üì• Response status:", response.status);
                
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                console.log("‚úÖ Success:", data);
                
                // Show success message
                successContainer.innerHTML = `<i class="fas fa-check me-1"></i>${data.message || 'C·∫≠p nh·∫≠t th√†nh c√¥ng!'}`;
                successContainer.style.display = 'block';
                
                // Optionally update displayed user info
                if (data.user) {
                    // Update any displayed user information on the page
                    console.log("Updated user data:", data.user);
                }
            })
            .catch(error => {
                console.error("‚ùå Error:", error);
                
                // Show error messages
                let errorHtml = '';
                if (typeof error === 'object' && error !== null) {
                    if (error.error) {
                        errorHtml = `<i class="fas fa-exclamation-triangle me-1"></i>${error.error}`;
                    } else {
                        errorHtml = '<ul class="mb-0">';
                        for (const [field, messages] of Object.entries(error)) {
                            const fieldMessages = Array.isArray(messages) ? messages : [messages];
                            errorHtml += `<li><strong>${field}:</strong> ${fieldMessages.join(', ')}</li>`;
                        }
                        errorHtml += '</ul>';
                    }
                } else {
                    errorHtml = `<i class="fas fa-exclamation-triangle me-1"></i>C√≥ l·ªói x·∫£y ra: ${error}`;
                }
                
                errorContainer.innerHTML = errorHtml;
                errorContainer.style.display = 'block';
            })
            .finally(() => {
                // Re-enable button
                updateButton.disabled = false;
                updateButton.innerHTML = '<i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t';
            });
        });
    } else {
        console.error("‚ùå Required elements not found");
    }
});
</script>
{% endblock %}